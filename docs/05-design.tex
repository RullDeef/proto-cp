\chapter{Конструкторский раздел}

% \section{Функциональная схема организации конференции}

%На рисунке \ref{img:idef0} представлена функциональная схема организации конференции в нотации IDEF0.

%\includeimage
%    {idef0}
%    {f}
%    {H}
%    {\linewidth}
%    {Функциональная схема организации конференции в нотации IDEF0}

\section{Функциональные требования к протоколу}

Ниже перечислены функциональные требования к разрабатываемому протоколу.

\begin{enumerate}
    \item Протокол должен поддерживать проведение одной конференции для произвольного количества участников.
    \item Участники должны иметь возможность подключаться и отключаться от конференции во время ее проведения.
\end{enumerate}

% \section{Граф переходов состояний для конференции}

% Конференция существует пока в ней есть хотя бы один участник.

% Конференция может находиться в следующих состояниях:

% \begin{enumerate}
%     \item Удалена или еще не создана.
%     \item Подготовительное.
%     \item Активное.
% \end{enumerate}

% В подготовительном состоянии происходит определение ролей всех участников, а также подготовка каналов передачи данных. При отключении одного из участников или подключении нового участника конференция также переходит в данное состояние.

\section{Роли участников конференции}

При создании конференции участник, который ее создает (и отправляет приглашения остальным участникам) назначается управляющим конференцией.

Управляющий конференцией имеет возможность редактировать параметры конференции, рассылать приглашения, а также передать свои полномочия другому участнику конференции.

% \section{Граф переходов состояний для участника конференции}

% 1. Не подключен к конференции.
% 2. Ожидание подключения к конференции.
% 3. Подготовительное состояние.
% 4. Активное состояние.

% Для того, чтобы подключиться к конференции, участник должен ожидать приглашения от управляющего конференцией, или от любого участника конференции (зависит от параметров самой конференции).

\section{Типы сообщений}

Разрабатываемый протокол предусматривает следующие типы передаваемых сообщений:
\begin{itemize}[label=---]
    \item \texttt{INVITE} --- приглашение в конференцию. Получатель сообщения подключается к конференции, в которой участвует отправитель.
    \item \texttt{INVITE\_ACCEPT} --- участник принимает приглашение.
    \item \texttt{INVITE\_REJECT} --- участник отклоняет приглашение.
    \item \texttt{PART\_PRESENCE} --- подключение/отключение участников конференции.
    \item \texttt{PART\_INFO} --- изменение состояния отдельного участника конференции.
    \item \texttt{REENTER} --- отправитель намеревается подключиться к существующей конференции (после потери соединения).
    \item \texttt{LEAVE} --- отправитель намеривается покинуть конференцию. Получатели должны финализировать все ресурсы, связанные с этим участником и разорвать соединения. Без использования данного типа сообщения будет происходить ожидание переподключения участника.
    \item \texttt{AUDIO} --- сообщение с аудио пакетом.
    \item \texttt{VIDEO} --- сообщение с видео пакетом.
\end{itemize}

Для передачи данных между участниками используется бинарный формат сообщений.

Схема типов сообщений представлена на рисунке \ref{img:msg-types}.
Первым полем любого сообщения передается его размер, затем поле с типом сообщения, в зависимости от которого происходит анализ содержимого сообщения.
\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{inc/diag/msg-types/msg-types.png}
  \caption{Схема типов сообщений с полями}
  \label{img:msg-types}
\end{figure}

Адрес подключения представляет собой структуру
\begin{verbatim}
struct Endpoint {
  union {
    sa_family_t af;
    struct sockaddr addr;
    struct sockaddr_in ipv4;
    struct sockaddr_in6 ipv6;
  };
  socklen_t addr_len;
};
\end{verbatim}

\section{Медиа форматы}

Снижение объемов передачи аудио/видео данных по сети требует использования кодеков, сжимающих медиа данные. Для разрабатываемого протокола применяются кодеки AAC \cite{aac} и H.264 \cite{h264}. Аудио кадр кодируется в стерео формате с частотой 48кГц. Видео кадр кодируется в разрешении 320 на 180 пикселей и частотой в 30 кадров в секунду.

\section{Взаимодействия сторон}

Рассмотрим сценарий с двумя участниками --- <<А>> и <<Б>>.
При создании конференции ей назначается случайный идентификатор. Для организации конференции, участник <<А>> отправляет участнику <<Б>> сообщение типа \texttt{INVITE}, в котором записывается идентификатор конференции, а также идентификатор и имя приглашающего участника.
После чего участник <<Б>> должен ответить на него сообщением \texttt{INVITE\_ACCEPT} для подключения к конференции участника <<А>>, при этом он покидает свою текущую конференцию, если ее идентификатор не совпадает с идентификатором конференции в приглашении.
После успешного подключения, происходит инициализация каналов передачи медиа данных.

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{inc/diag/seq-2/conf-2.png}
  \caption{Диаграмма последовательности для организации конференции для двух участников}
  \label{img:conf-2}
\end{figure}

Аудио и видео пакеты передаются с использованием сообщений типов \texttt{AUDIO} / \texttt{VIDEO}.
Диаграмма последовательности описанного процесса представлена на рисунке \ref{img:conf-2}.

Подключение последующих участников происходит аналогичным образом --- любой из активных участников конференции отправляет сообщение типа \texttt{INVITE} с приглашением в конференцию новому участнику, и, после получения ответного сообщения \texttt{INVITE\_ACCEPT}, отправляет сообщение \texttt{PART\_PRESENCE} остальным участникам конференции для уведомления о подключении нового участника.
Каждый из остальных участников, получив сообщение \texttt{PART\_PRESENCE} отправляет приглашение \texttt{INVITE} новому участнику для инициализации каналов связи между всеми парами участников конференции.
Диаграмма последовательности описанного процесса представлена на рисунке \ref{img:conf-3}.

\begin{figure}[H]
  \centering
  \includegraphics[width=0.9\linewidth]{inc/diag/seq-3/conf-3.png}
  \caption{Диаграмма последовательности для организации конференции для трех и более участников}
  \label{img:conf-3}
\end{figure}

Для обеспечения уникальной идентификации участников в условиях, когда несколько клиентов могут находиться за NAT с одним IP-адресом, в протоколе используются уникальные идентификаторы участников.
Эти идентификаторы генерируются случайным образом при подключении участника к конференции и используются для однозначной идентификации в рамках сессии.

\section{Шифрование}

Шифрование используется для обеспечения целостности и конфиденциальности передаваемых данных. (Защита от подслушивания, порчи и/или подделки сообщений).
Проверка сертификатов разрабатываемым протоколом не предусмотрена, но может быть проведена при повторном соединении с участником.
В качестве протокола шифрования используется TLS v1.3 \cite{tls}.

%В итоге, выбор между TCP+TLS и SRTP зависит от конкретных требований проекта. TCP+TLS лучше подходит для приложений, где важны надежность, безопасность и совместимость, в то время как SRTP более эффективен для передачи мультимедийных данных с низкой задержкой. Важно также учитывать ресурсные ограничения целевых платформ и сложность реализации каждого из подходов.

\section{Переподключение}

При потере соединения без получения сообщения \texttt{LEAVE} небходимо ожидать переподключение участника в течении 30 секунд. Если участник так и не подключился к конференции, то он считается вышедшим из конференции и в последующем сможет подключиться к ней только через приглашение от другого участника конференции.

Переподключение производится отправкой сообщения \texttt{REENTER} с идентификатором текущей конференции и идентификатором участника, потерявшего соединение. Если сообщение было получено по истечению 30 секундного интервала --- оно отбрасывается, соединение закрывается и участник считывается неподключившимся.

\section{Определение качества каналов связи}

Для реформирования топологии связей в бессерверных видео конференциях необходимо определить качество существующих каналов связи между участниками. Это может быть выполнено с использованием метрик, которые зависят от следующих параметров: временные метки отправки/приема аудио/видео пакета; размер пакета в байтах; количество переданных и повторно переданных пакетов.

На основе этих параметров могут быть вычислены такие показатели качества как:
\begin{itemize}[label=---]
  \item задержка передачи --- временная разница между отправкой и получением пакета;
  \item джиттер --- вариация задержки между последовательными пакетами;
  \item пропускная способность --- объем данных, переданных за определенный период времени.
\end{itemize}
